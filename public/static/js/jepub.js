/*! jepub - 2.3.0 | (c) 2018 lelinhtinh | ISC | https://lelinhtinh.github.io/jEpub/ */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("jszip"),require("ejs")):"function"==typeof define&&define.amd?define(["jszip","ejs"],t):(e="undefined"!=typeof globalThis?globalThis:e||self).jEpub=t(e.JSZip,e.ejs)}(this,(function(JSZip,ejs){"use strict";function uuidv4(){if("undefined"==typeof crypto||!crypto.getRandomValues)throw new Error("crypto.getRandomValues is not available");return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,(e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16)))}function isEmpty(e){return null===e||"string"==typeof e&&!e.trim()}function getISODate(e=new Date){return e.toISOString()}let jsdomModule=null,jsdomLoadAttempted=!1;function getJSDOM(){if(!jsdomLoadAttempted){jsdomLoadAttempted=!0;try{const module=eval("require")("jsdom");jsdomModule=module}catch{jsdomModule=null}}return jsdomModule}const HTML_ENTITIES={"&nbsp;":" ","&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'"};function simpleHtmlToText(e){let t=e.replace(/<[^>]+>/g,"");return Object.entries(HTML_ENTITIES).forEach((([e,i])=>{t=t.replace(new RegExp(e,"gi"),i)})),t.trim()}function parseWithJSDOM(e,t){const i=getJSDOM();if(!i)return null;try{const{JSDOM:n}=i,o=new n(`<!doctype html><body>${e}</body>`),r=o.window.document;if(t)return r.body.textContent.trim();const a=o.window.XMLSerializer;if(a){const e=new a;return e.serializeToString(r.body).replace(/(^<body\s?[^>]*>|<\/body>$)/g,"")}return r.body.innerHTML}catch{return null}}function parseWithBrowserDOM(e,t){const i=(new DOMParser).parseFromString(`<!doctype html><body>${e}`,"text/html");if(t)return i.body.textContent.trim();return(new XMLSerializer).serializeToString(i.body).replace(/(^<body\s?[^>]*>|<\/body>$)/g,"")}function parseDOM(e,t=!1){if("string"!=typeof e)return"";if("undefined"==typeof DOMParser){const i=parseWithJSDOM(e,t);return null!==i?i:t?simpleHtmlToText(e):e}return parseWithBrowserDOM(e,t)}function html2text(e,t=!1){if("string"!=typeof e)return"";let i=e.replace(/<style([\s\S]*?)<\/style>/gi,"");i=i.replace(/<script([\s\S]*?)<\/script>/gi,""),i=i.replace(/<\/(div|p|li|dd|h[1-6])>/gi,"\n"),i=i.replace(/<(br|hr)\s*[/]?>/gi,"\n"),i=i.replace(/<li>/gi,"+ "),i=i.replace(/<[^>]+>/g,""),i=i.replace(/\n{3,}/g,"\n\n");const n=parseDOM(i,!0);return t?n.replace(/\n+/g," "):n}function validateUrl(e){if("string"!=typeof e)return!1;return/^(?:(?:https?|ftp):\/\/)(?:\S+(?::\S*)?@)?(?:(?!(?:10|127)(?:\.\d{1,3}){3})(?!(?:169\.254|192\.168)(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)(?:\.(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)*(?:\.(?:[a-z\u00a1-\uffff]{2,}))\.?)(?::\d{2,5})?(?:[/?#]\S*)?$/i.test(e)}const MIME_TO_EXTENSION={"image/jpg":"jpg","image/jpeg":"jpg","image/svg+xml":"svg","image/gif":"gif","image/apng":"apng","image/png":"png","image/webp":"webp","image/bmp":"bmp"};function mime2ext(e){if("string"!=typeof e)return null;if(MIME_TO_EXTENSION[e])return MIME_TO_EXTENSION[e];if(e.startsWith("image/")){const t=e.split("/")[1];if(["gif","apng","png","webp","bmp"].includes(t))return t}return null}function getDefaultExportFromCjs(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var imageType$1={exports:{}},fileType={exports:{}},hasRequiredFileType,hasRequiredImageType;function requireFileType(){return hasRequiredFileType||(hasRequiredFileType=1,function(module){const toBytes=e=>[...e].map((e=>e.charCodeAt(0))),xpiZipFilename=toBytes("META-INF/mozilla.rsa"),oxmlContentTypes=toBytes("[Content_Types].xml"),oxmlRels=toBytes("_rels/.rels");function readUInt64LE(e,t=0){let i=e[t],n=1,o=0;for(;++o<8;)n*=256,i+=e[t+o]*n;return i}const fileType=e=>{if(!(e instanceof Uint8Array||e instanceof ArrayBuffer||Buffer.isBuffer(e)))throw new TypeError(`Expected the \`input\` argument to be of type \`Uint8Array\` or \`Buffer\` or \`ArrayBuffer\`, got \`${typeof e}\``);const t=e instanceof Uint8Array?e:new Uint8Array(e);if(!(t&&t.length>1))return null;const i=(e,i)=>{i=Object.assign({offset:0},i);for(let n=0;n<e.length;n++)if(i.mask){if(e[n]!==(i.mask[n]&t[n+i.offset]))return!1}else if(e[n]!==t[n+i.offset])return!1;return!0},n=(e,t)=>i(toBytes(e),t);if(i([255,216,255]))return{ext:"jpg",mime:"image/jpeg"};if(i([137,80,78,71,13,10,26,10]))return{ext:"png",mime:"image/png"};if(i([71,73,70]))return{ext:"gif",mime:"image/gif"};if(i([87,69,66,80],{offset:8}))return{ext:"webp",mime:"image/webp"};if(i([70,76,73,70]))return{ext:"flif",mime:"image/flif"};if((i([73,73,42,0])||i([77,77,0,42]))&&i([67,82],{offset:8}))return{ext:"cr2",mime:"image/x-canon-cr2"};if(i([73,73,42,0])||i([77,77,0,42]))return{ext:"tif",mime:"image/tiff"};if(i([66,77]))return{ext:"bmp",mime:"image/bmp"};if(i([73,73,188]))return{ext:"jxr",mime:"image/vnd.ms-photo"};if(i([56,66,80,83]))return{ext:"psd",mime:"image/vnd.adobe.photoshop"};if(i([80,75,3,4])){if(i([109,105,109,101,116,121,112,101,97,112,112,108,105,99,97,116,105,111,110,47,101,112,117,98,43,122,105,112],{offset:30}))return{ext:"epub",mime:"application/epub+zip"};if(i(xpiZipFilename,{offset:30}))return{ext:"xpi",mime:"application/x-xpinstall"};if(n("mimetypeapplication/vnd.oasis.opendocument.text",{offset:30}))return{ext:"odt",mime:"application/vnd.oasis.opendocument.text"};if(n("mimetypeapplication/vnd.oasis.opendocument.spreadsheet",{offset:30}))return{ext:"ods",mime:"application/vnd.oasis.opendocument.spreadsheet"};if(n("mimetypeapplication/vnd.oasis.opendocument.presentation",{offset:30}))return{ext:"odp",mime:"application/vnd.oasis.opendocument.presentation"};const e=(e,t=0)=>e.findIndex(((e,i,n)=>i>=t&&80===n[i]&&75===n[i+1]&&3===n[i+2]&&4===n[i+3]));let o=0,r=!1,a=null;do{const m=o+30;if(r||(r=i(oxmlContentTypes,{offset:m})||i(oxmlRels,{offset:m})),a||(n("word/",{offset:m})?a={ext:"docx",mime:"application/vnd.openxmlformats-officedocument.wordprocessingml.document"}:n("ppt/",{offset:m})?a={ext:"pptx",mime:"application/vnd.openxmlformats-officedocument.presentationml.presentation"}:n("xl/",{offset:m})&&(a={ext:"xlsx",mime:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"})),r&&a)return a;o=e(t,m)}while(o>=0);if(a)return a}if(i([80,75])&&(3===t[2]||5===t[2]||7===t[2])&&(4===t[3]||6===t[3]||8===t[3]))return{ext:"zip",mime:"application/zip"};if(i([117,115,116,97,114],{offset:257}))return{ext:"tar",mime:"application/x-tar"};if(i([82,97,114,33,26,7])&&(0===t[6]||1===t[6]))return{ext:"rar",mime:"application/x-rar-compressed"};if(i([31,139,8]))return{ext:"gz",mime:"application/gzip"};if(i([66,90,104]))return{ext:"bz2",mime:"application/x-bzip2"};if(i([55,122,188,175,39,28]))return{ext:"7z",mime:"application/x-7z-compressed"};if(i([120,1]))return{ext:"dmg",mime:"application/x-apple-diskimage"};if(i([51,103,112,53])||i([0,0,0])&&i([102,116,121,112],{offset:4})&&(i([109,112,52,49],{offset:8})||i([109,112,52,50],{offset:8})||i([105,115,111,109],{offset:8})||i([105,115,111,50],{offset:8})||i([109,109,112,52],{offset:8})||i([77,52,86],{offset:8})||i([100,97,115,104],{offset:8})))return{ext:"mp4",mime:"video/mp4"};if(i([77,84,104,100]))return{ext:"mid",mime:"audio/midi"};if(i([26,69,223,163])){const e=t.subarray(4,4100),i=e.findIndex(((e,t,i)=>66===i[t]&&130===i[t+1]));if(-1!==i){const t=i+3,n=i=>[...i].every(((i,n)=>e[t+n]===i.charCodeAt(0)));if(n("matroska"))return{ext:"mkv",mime:"video/x-matroska"};if(n("webm"))return{ext:"webm",mime:"video/webm"}}}if(i([0,0,0,20,102,116,121,112,113,116,32,32])||i([102,114,101,101],{offset:4})||i([102,116,121,112,113,116,32,32],{offset:4})||i([109,100,97,116],{offset:4})||i([109,111,111,118],{offset:4})||i([119,105,100,101],{offset:4}))return{ext:"mov",mime:"video/quicktime"};if(i([82,73,70,70])){if(i([65,86,73],{offset:8}))return{ext:"avi",mime:"video/vnd.avi"};if(i([87,65,86,69],{offset:8}))return{ext:"wav",mime:"audio/vnd.wave"};if(i([81,76,67,77],{offset:8}))return{ext:"qcp",mime:"audio/qcelp"}}if(i([48,38,178,117,142,102,207,17,166,217])){let e=30;do{const n=readUInt64LE(t,e+16);if(i([145,7,220,183,183,169,207,17,142,230,0,192,12,32,83,101],{offset:e})){if(i([64,158,105,248,77,91,207,17,168,253,0,128,95,92,68,43],{offset:e+24}))return{ext:"wma",mime:"audio/x-ms-wma"};if(i([192,239,25,188,77,91,207,17,168,253,0,128,95,92,68,43],{offset:e+24}))return{ext:"wmv",mime:"video/x-ms-asf"};break}e+=n}while(e+24<=t.length);return{ext:"asf",mime:"application/vnd.ms-asf"}}if(i([0,0,1,186])||i([0,0,1,179]))return{ext:"mpg",mime:"video/mpeg"};if(i([102,116,121,112,51,103],{offset:4}))return{ext:"3gp",mime:"video/3gpp"};for(let o=0;o<2&&o<t.length-16;o++){if(i([73,68,51],{offset:o})||i([255,226],{offset:o,mask:[255,226]}))return{ext:"mp3",mime:"audio/mpeg"};if(i([255,228],{offset:o,mask:[255,228]}))return{ext:"mp2",mime:"audio/mpeg"};if(i([255,248],{offset:o,mask:[255,252]}))return{ext:"mp2",mime:"audio/mpeg"};if(i([255,240],{offset:o,mask:[255,252]}))return{ext:"mp4",mime:"audio/mpeg"}}if(i([102,116,121,112,77,52,65],{offset:4}))return{ext:"m4a",mime:"audio/mp4"};if(i([79,112,117,115,72,101,97,100],{offset:28}))return{ext:"opus",mime:"audio/opus"};if(i([79,103,103,83]))return i([128,116,104,101,111,114,97],{offset:28})?{ext:"ogv",mime:"video/ogg"}:i([1,118,105,100,101,111,0],{offset:28})?{ext:"ogm",mime:"video/ogg"}:i([127,70,76,65,67],{offset:28})?{ext:"oga",mime:"audio/ogg"}:i([83,112,101,101,120,32,32],{offset:28})?{ext:"spx",mime:"audio/ogg"}:i([1,118,111,114,98,105,115],{offset:28})?{ext:"ogg",mime:"audio/ogg"}:{ext:"ogx",mime:"application/ogg"};if(i([102,76,97,67]))return{ext:"flac",mime:"audio/x-flac"};if(i([77,65,67,32]))return{ext:"ape",mime:"audio/ape"};if(i([119,118,112,107]))return{ext:"wv",mime:"audio/wavpack"};if(i([35,33,65,77,82,10]))return{ext:"amr",mime:"audio/amr"};if(i([37,80,68,70]))return{ext:"pdf",mime:"application/pdf"};if(i([77,90]))return{ext:"exe",mime:"application/x-msdownload"};if((67===t[0]||70===t[0])&&i([87,83],{offset:1}))return{ext:"swf",mime:"application/x-shockwave-flash"};if(i([123,92,114,116,102]))return{ext:"rtf",mime:"application/rtf"};if(i([0,97,115,109]))return{ext:"wasm",mime:"application/wasm"};if(i([119,79,70,70])&&(i([0,1,0,0],{offset:4})||i([79,84,84,79],{offset:4})))return{ext:"woff",mime:"font/woff"};if(i([119,79,70,50])&&(i([0,1,0,0],{offset:4})||i([79,84,84,79],{offset:4})))return{ext:"woff2",mime:"font/woff2"};if(i([76,80],{offset:34})&&(i([0,0,1],{offset:8})||i([1,0,2],{offset:8})||i([2,0,2],{offset:8})))return{ext:"eot",mime:"application/vnd.ms-fontobject"};if(i([0,1,0,0,0]))return{ext:"ttf",mime:"font/ttf"};if(i([79,84,84,79,0]))return{ext:"otf",mime:"font/otf"};if(i([0,0,1,0]))return{ext:"ico",mime:"image/x-icon"};if(i([0,0,2,0]))return{ext:"cur",mime:"image/x-icon"};if(i([70,76,86,1]))return{ext:"flv",mime:"video/x-flv"};if(i([37,33]))return{ext:"ps",mime:"application/postscript"};if(i([253,55,122,88,90,0]))return{ext:"xz",mime:"application/x-xz"};if(i([83,81,76,105]))return{ext:"sqlite",mime:"application/x-sqlite3"};if(i([78,69,83,26]))return{ext:"nes",mime:"application/x-nintendo-nes-rom"};if(i([67,114,50,52]))return{ext:"crx",mime:"application/x-google-chrome-extension"};if(i([77,83,67,70])||i([73,83,99,40]))return{ext:"cab",mime:"application/vnd.ms-cab-compressed"};if(i([33,60,97,114,99,104,62,10,100,101,98,105,97,110,45,98,105,110,97,114,121]))return{ext:"deb",mime:"application/x-deb"};if(i([33,60,97,114,99,104,62]))return{ext:"ar",mime:"application/x-unix-archive"};if(i([237,171,238,219]))return{ext:"rpm",mime:"application/x-rpm"};if(i([31,160])||i([31,157]))return{ext:"Z",mime:"application/x-compress"};if(i([76,90,73,80]))return{ext:"lz",mime:"application/x-lzip"};if(i([208,207,17,224,161,177,26,225]))return{ext:"msi",mime:"application/x-msi"};if(i([6,14,43,52,2,5,1,1,13,1,2,1,1,2]))return{ext:"mxf",mime:"application/mxf"};if(i([71],{offset:4})&&(i([71],{offset:192})||i([71],{offset:196})))return{ext:"mts",mime:"video/mp2t"};if(i([66,76,69,78,68,69,82]))return{ext:"blend",mime:"application/x-blender"};if(i([66,80,71,251]))return{ext:"bpg",mime:"image/bpg"};if(i([0,0,0,12,106,80,32,32,13,10,135,10])){if(i([106,112,50,32],{offset:20}))return{ext:"jp2",mime:"image/jp2"};if(i([106,112,120,32],{offset:20}))return{ext:"jpx",mime:"image/jpx"};if(i([106,112,109,32],{offset:20}))return{ext:"jpm",mime:"image/jpm"};if(i([109,106,112,50],{offset:20}))return{ext:"mj2",mime:"image/mj2"}}if(i([70,79,82,77]))return{ext:"aif",mime:"audio/aiff"};if(n("<?xml "))return{ext:"xml",mime:"application/xml"};if(i([66,79,79,75,77,79,66,73],{offset:60}))return{ext:"mobi",mime:"application/x-mobipocket-ebook"};if(i([102,116,121,112],{offset:4})){if(i([109,105,102,49],{offset:8}))return{ext:"heic",mime:"image/heif"};if(i([109,115,102,49],{offset:8}))return{ext:"heic",mime:"image/heif-sequence"};if(i([104,101,105,99],{offset:8})||i([104,101,105,120],{offset:8}))return{ext:"heic",mime:"image/heic"};if(i([104,101,118,99],{offset:8})||i([104,101,118,120],{offset:8}))return{ext:"heic",mime:"image/heic-sequence"}}return i([171,75,84,88,32,49,49,187,13,10,26,10])?{ext:"ktx",mime:"image/ktx"}:i([68,73,67,77],{offset:128})?{ext:"dcm",mime:"application/dicom"}:i([77,80,43])||i([77,80,67,75])?{ext:"mpc",mime:"audio/x-musepack"}:i([66,69,71,73,78,58])?{ext:"ics",mime:"text/calendar"}:i([103,108,84,70,2,0,0,0])?{ext:"glb",mime:"model/gltf-binary"}:i([212,195,178,161])||i([161,178,195,212])?{ext:"pcap",mime:"application/vnd.tcpdump.pcap"}:null};module.exports=fileType,module.exports.default=fileType,Object.defineProperty(fileType,"minimumBytes",{value:4100}),module.exports.stream=readableStream=>new Promise(((resolve,reject)=>{const stream=eval("require")("stream");readableStream.once("readable",(()=>{const e=new stream.PassThrough,t=readableStream.read(module.exports.minimumBytes)||readableStream.read();try{e.fileType=fileType(t)}catch(i){reject(i)}readableStream.unshift(t),stream.pipeline?resolve(stream.pipeline(readableStream,e,(()=>{}))):resolve(readableStream.pipe(e))}))}))}(fileType)),fileType.exports}function requireImageType(){if(hasRequiredImageType)return imageType$1.exports;hasRequiredImageType=1;const e=requireFileType(),t=new Set(["jpg","png","gif","webp","flif","cr2","tif","bmp","jxr","psd","ico","bpg","jp2","jpm","jpx","heic","cur","dcm"]),i=i=>{const n=e(i);return t.has(n&&n.ext)?n:null};return imageType$1.exports=i,imageType$1.exports.default=i,Object.defineProperty(i,"minimumBytes",{value:e.minimumBytes}),imageType$1.exports}var imageTypeExports=requireImageType();const imageType=getDefaultExportFromCjs(imageTypeExports),en={code:"en",cover:"Cover",toc:"Table of Contents",info:"Information",note:"Notes"},vi={code:"vi",cover:"Bìa sách",toc:"Mục lục",info:"Giới thiệu",note:"Ghi chú"},hi={code:"hi",cover:"आवरण",toc:"विषय - सूची",info:"जानकारी",note:"टिप्पणियाँ"},fr={code:"fr",cover:"Couverture",toc:"Table des matières",info:"Information",note:"Notes"},de={code:"de",cover:"Umschlag",toc:"Inhaltsverzeichnis",info:"Information",note:"Notizen"},es={code:"es",cover:"Portada",toc:"Tabla de contenidos",info:"Información",note:"Notas"},it={code:"it",cover:"Copertina",toc:"Indice",info:"Informazioni",note:"Note"},pt={code:"pt",cover:"Capa",toc:"Índice",info:"Informação",note:"Notas"},ru={code:"ru",cover:"Обложка",toc:"Содержание",info:"Информация",note:"Заметки"},ja={code:"ja",cover:"表紙",toc:"目次",info:"情報",note:"ノート"},ko={code:"ko",cover:"표지",toc:"목차",info:"정보",note:"메모"},zh={code:"zh",cover:"封面",toc:"目录",info:"信息",note:"注释"},ar={code:"ar",cover:"الغلاف",toc:"جدول المحتويات",info:"معلومات",note:"ملاحظات"},nl={code:"nl",cover:"Omslag",toc:"Inhoudsopgave",info:"Informatie",note:"Notities"},sv={code:"sv",cover:"Omslag",toc:"Innehållsförteckning",info:"Information",note:"Anteckningar"},da={code:"da",cover:"Omslag",toc:"Indholdsfortegnelse",info:"Information",note:"Noter"},no={code:"no",cover:"Omslag",toc:"Innholdsfortegnelse",info:"Informasjon",note:"Notater"},fi={code:"fi",cover:"Kansi",toc:"Sisällysluettelo",info:"Tiedot",note:"Muistiinpanot"},pl={code:"pl",cover:"Okładka",toc:"Spis treści",info:"Informacje",note:"Notatki"},cs={code:"cs",cover:"Obal",toc:"Obsah",info:"Informace",note:"Poznámky"},tr={code:"tr",cover:"Kapak",toc:"İçindekiler",info:"Bilgi",note:"Notlar"},language={en:en,vi:vi,hi:hi,fr:fr,de:de,es:es,it:it,pt:pt,ru:ru,ja:ja,ko:ko,zh:zh,ar:ar,nl:nl,sv:sv,da:da,no:no,fi:fi,pl:pl,cs:cs,tr:tr},container='<?xml version="1.0" encoding="UTF-8" ?>\n<container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container">\n\t<rootfiles>\n\t\t<rootfile full-path="book.opf" media-type="application/oebps-package+xml" />\n\t</rootfiles>\n</container>',cover='<?xml version="1.0" encoding="UTF-8" ?>\n<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">\n<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="<%= i18n.code %>">\n\n<head>\n\t<title><%= i18n.cover %></title>\n\t<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=utf-8" />\n</head>\n\n<body>\n\t<div id="cover-image">\n\t\t<img src="../<%= cover.path %>" alt="<%= i18n.cover %>" />\n\t</div>\n</body>\n\n</html>\n',notes='<?xml version="1.0" encoding="UTF-8" ?>\n<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">\n<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="<%= i18n.code %>">\n\n<head>\n\t<title><%= i18n.note %></title>\n\t<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=utf-8" />\n</head>\n\n<body>\n\t<div id="notes-page">\n\t\t<div class="ugc">\n            <%- notes %>\n\t\t</div>\n\t</div>\n</body>\n\n</html>\n',page='<?xml version="1.0" encoding="UTF-8" ?>\n<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">\n<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="<%= i18n.code %>">\n\n<head>\n\t<title><%= title %></title>\n\t<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=utf-8" />\n</head>\n\n<body>\n\t<div class="chapter type-1">\n\t\t<div class="chapter-title-wrap">\n\t\t\t<h2 class="chapter-title"><%= title %></h2>\n\t\t</div>\n        <% if (content) { %>\n            <div class="ugc chapter-ugc">\n                <% if (Array.isArray(content)) { %>\n                    <% content.forEach(item => { %>\n                        <p class="indent"><%= item %></p>\n                    <% }); %>\n                <% } else { %>\n                    <%- content %>\n                <% } %>\n            </div>\n        <% } %>\n\t</div>\n</body>\n\n</html>\n',tocInBook='<?xml version="1.0" encoding="UTF-8" ?>\n<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">\n<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="<%= i18n.code %>">\n\n<head>\n\t<title><%= i18n.toc %></title>\n\t<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=utf-8" />\n</head>\n\n<body>\n\t<div id="toc">\n\t\t<h1><%= i18n.toc %></h1>\n\t\t<ul>\n            <% let currentLevel = 0; %>\n            <% pages.forEach(({title,level}, index) => { %>\n                <% if (level > currentLevel) { %>\n                    <ul>\n                <% } %>\n                <li class="chaptertype-1">\n                    <a href="page-<%= index %>.html">\n                        <span class="toc-chapter-title"><%= title %></span>\n                    </a>\n                </li>\n                <% if (level < currentLevel) { %>\n                    <% for (let i = currentLevel; i > level; i--) { %>\n                        </ul>\n                    <% } %>\n                <% } %>\n                <% currentLevel = level; %>\n            <% }); %>\n            <% if (currentLevel > 0) { %>\n                <% for (let i = currentLevel; i > 0; i--) { %>\n                    </ul>\n                <% } %>\n            <% } %>\n\t\t</ul>\n\t</div>\n</body>\n\n</html>\n',info='<?xml version="1.0" encoding="UTF-8" ?>\n<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">\n<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="<%= i18n.code %>">\n\n<head>\n\t<title><%= i18n.info %></title>\n\t<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=utf-8" />\n</head>\n\n<body>\n\t<div id="title-page">\n\t\t<h1 class="title"><%= title %></h1>\n\t\t<h2 class="subtitle"></h2>\n\t\t<h3 class="author"><%= author %></h3>\n\t\t<h4 class="publisher"><%= publisher %></h4>\n\t</div>\n    <% if (Array.isArray(tags) && tags.length) { %>\n        <div class="part-title-wrap">\n            <% tags = tags.join(\'</code>, <code>\'); %>\n            <code><%- tags %></code>\n        </div>\n    <% } %>\n    <% if (description) { %>\n        <div class="ugc">\n            <%- description %>\n        </div>\n    <% } %>\n</body>\n\n</html>\n',bookConfig='<?xml version="1.0" encoding="UTF-8" ?>\n<package version="2.0" xmlns="http://www.idpf.org/2007/opf" unique-identifier="PrimaryID">\n\n\t<metadata xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:opf="http://www.idpf.org/2007/opf">\n\t\t<dc:title><%= title %></dc:title>\n\t\t<dc:language><%= i18n.code %></dc:language>\n\t\t<dc:identifier id="PrimaryID" opf:scheme="<%= uuid.scheme %>"><%= uuid.id %></dc:identifier>\n        <dc:date opf:event="publication"><%= date %></dc:date>\n        <% if (description) { %>\n\t\t    <dc:description><%= description %></dc:description>\n        <% } %>\n\t\t<dc:creator opf:role="aut"><%= author %></dc:creator>\n\t\t<dc:publisher><%= publisher %></dc:publisher>\n        <% if (cover) { %>\n\t\t    <meta name="cover" content="cover-image" />\n        <% } %>\n        <% if (Array.isArray(tags) && tags.length) tags.forEach(tag => { %>\n            <dc:subject><%= tag %></dc:subject>\n        <% }); %>\n\t</metadata>\n\n\t<manifest>\n        <% if (cover) { %>\n\t\t    <item id="front-cover" href="OEBPS/front-cover.html" media-type="application/xhtml+xml" />\n        <% } %>\n\t\t<item id="title-page" href="OEBPS/title-page.html" media-type="application/xhtml+xml" />\n\t\t<item id="notes" href="OEBPS/notes.html" media-type="application/xhtml+xml" />\n\t\t<item id="table-of-contents" href="OEBPS/table-of-contents.html" media-type="application/xhtml+xml" />\n        <% pages.forEach((page, index) => { %>\n            <item id="page-<%= index %>" href="OEBPS/page-<%= index %>.html" media-type="application/xhtml+xml" />\n        <% }); %>\n        <% if (cover) { %>\n\t\t    <item id="cover-image" href="<%= cover.path %>" media-type="<%= cover.type %>" />\n        <% } %>\n\t\t<item id="ncx" href="toc.ncx" media-type="application/x-dtbncx+xml" />\n        <% Object.keys(images).forEach(name => { %>\n            <item id="<%= name %>" href="OEBPS/<%= images[name].path %>" media-type="<%= images[name].type %>" />\n        <% }); %>\n\t</manifest>\n\n\t<spine toc="ncx">\n        <% if (cover) { %>\n\t\t    <itemref idref="front-cover" linear="no" />\n        <% } %>\n\t\t<itemref idref="title-page" linear="yes" />\n\t\t<itemref idref="table-of-contents" linear="yes" />\n        <% pages.forEach((page, index) => { %>\n            <itemref idref="page-<%= index %>" linear="yes" />\n        <% }); %>\n        <% if (notes) { %>\n            <itemref idref="notes" linear="yes" />\n        <% } %>\n\t</spine>\n\n\t<guide>\n        <% if (cover) { %>\n\t\t    <reference type="cover" title="<%= i18n.cover %>" href="OEBPS/front-cover.html" />\n        <% } %>\n\t\t<reference type="toc" title="<%= i18n.toc %>" href="OEBPS/table-of-contents.html" />\n\t</guide>\n\n</package>\n',mime="application/epub+zip",toc='<?xml version="1.0" encoding="UTF-8" ?>\n<!DOCTYPE ncx PUBLIC "-//NISO//DTD ncx 2005-1//EN" "http://www.daisy.org/z3986/2005/ncx-2005-1.dtd">\n\n<ncx version="2005-1" xml:lang="<%= i18n.code %>" xmlns="http://www.daisy.org/z3986/2005/ncx/">\n\t<head>\n\t\t<meta name="dtb:uid" content="<%= uuid.id %>" />\n\t\t<meta name="dtb:depth" content="2" />\n\t\t<meta name="dtb:totalPageCount" content="0" />\n\t\t<meta name="dtb:maxPageNumber" content="0" />\n\t</head>\n\n\t<docTitle>\n\t\t<text><%= title %></text>\n\t</docTitle>\n\n\t<docAuthor>\n\t\t<text><%= author %></text>\n\t</docAuthor>\n\n\t<navMap>\n\t\t<navPoint id="title-page" playOrder="1">\n\t\t\t<navLabel>\n\t\t\t\t<text><%= i18n.info %></text>\n\t\t\t</navLabel>\n\t\t\t<content src="OEBPS/title-page.html" />\n\t\t</navPoint>\n\t\t<navPoint id="table-of-contents" playOrder="2">\n\t\t\t<navLabel>\n\t\t\t\t<text><%= i18n.toc %></text>\n\t\t\t</navLabel>\n\t\t\t<content src="OEBPS/table-of-contents.html" />\n\t\t</navPoint>\n        <% let currentLevel = -1; %>\n        <% pages.forEach(({title,level}, index) => { %>\n            <% if (level <= currentLevel) { %>\n                <% for (let i = currentLevel; i >= level; i--) { %>\n                    </navPoint>\n                <% } %>\n            <% } %>\n            <navPoint id="page-<%= index %>" playOrder="<%= (index + 3) %>">\n                <navLabel>\n                    <text><%= title %></text>\n                </navLabel>\n                <content src="OEBPS/page-<%= index %>.html" />\n            <% currentLevel = level; %>\n        <% }); %>\n        <% if (currentLevel >= 0) { %>\n            <% for (let i = currentLevel; i >= 0; i--) { %>\n                </navPoint>\n            <% } %>\n        <% } %>\n        <% if (notes) { %>\n            <navPoint id="notes-page" playOrder="2">\n                <navLabel>\n                    <text><%= i18n.note %></text>\n                </navLabel>\n                <content src="OEBPS/notes.html" />\n            </navPoint>\n        <% } %>\n\t</navMap>\n</ncx>\n';class jEpub{constructor(){this._I18n={},this._Info={},this._Uuid={},this._Date=null,this._Cover=null,this._Pages=[],this._Images=[],this._Zip={}}init(e){if(e instanceof JSZip)return this._Zip=e,this;if(this._Info=Object.assign({},{i18n:"en",title:"undefined",author:"undefined",publisher:"undefined",description:"",tags:[]},e),this._Uuid={scheme:"uuid",id:uuidv4()},this._Date=getISODate(),!language[this._Info.i18n])throw`Unknown Language: ${this._Info.i18n}`;return this._I18n=language[this._Info.i18n],this._Zip=new JSZip,this._Zip.file("mimetype",mime),this._Zip.file("META-INF/container.xml",container),this._Zip.file("OEBPS/title-page.html",ejs.render(info,{i18n:this._I18n,title:this._Info.title,author:this._Info.author,publisher:this._Info.publisher,description:parseDOM(this._Info.description),tags:this._Info.tags},{client:!0})),this}static html2text(e,t=!1){return html2text(e,t)}date(e){if(e instanceof Date)return this._Date=getISODate(e),this;throw"Date object is not valid"}uuid(e){if(isEmpty(e))throw"UUID value is empty";{let t="uuid";return validateUrl(e)&&(t="URI"),this._Uuid={scheme:t,id:e},this}}cover(e){let t,i;if(e instanceof Blob)i=e.type,t=mime2ext(i);else{if(!(e instanceof ArrayBuffer))throw"Cover data is not valid";t=imageType(new Uint8Array(e)),t&&(i=t.mime,t=mime2ext(i))}if(!t)throw"Cover data is not allowed";return this._Cover={type:i,path:`OEBPS/cover-image.${t}`},this._Zip.file(this._Cover.path,e),this._Zip.file("OEBPS/front-cover.html",ejs.render(cover,{i18n:this._I18n,cover:this._Cover},{client:!0})),this}image(e,t){let i,n;if(e instanceof Blob)n=e.type,i=mime2ext(n);else{if(!(e instanceof ArrayBuffer))throw"Image data is not valid";i=imageType(new Uint8Array(e)),n=i.mime,i&&(i=mime2ext(n))}if(!i)throw"Image data is not allowed";const o=`assets/${t}.${i}`;return this._Images[t]={type:n,path:o},this._Zip.file(`OEBPS/${o}`,e),this}notes(e){if(isEmpty(e))throw"Notes is empty";return this._Zip.file("OEBPS/notes.html",ejs.render(notes,{i18n:this._I18n,notes:parseDOM(e)},{client:!0})),this}add(e,t=null,i=0){if(isEmpty(e))throw"Title is empty";if("number"!=typeof i||isNaN(i)||i<0)throw"Level must be a non-negative number";const n=this._Pages[this._Pages.length-1];if(n&&i>n.level+1)throw`Invalid TOC hierarchy: Level can only increase by 1 (from ${n.level} to ${n.level+1})`;if(t&&!Array.isArray(t)){t=parseDOM(t=ejs.compile(t,{client:!0})({image:this._Images},(e=>`<img src="${e?e.path:"data:image/gif;base64,R0lGODlhAQABAIAAAAUEBAAAACwAAAAAAQABAAACAkQBADs="}" alt=""></img>`)))}const o=this._Pages.length;return this._Zip.file(`OEBPS/page-${o}.html`,ejs.render(page,{i18n:this._I18n,title:e,content:t},{client:!0})),this._Pages.push({title:e,level:i}),this}generate(e="blob",t){if(!JSZip.support[e])throw`This browser does not support ${e}`;let i=this._Zip.file("OEBPS/notes.html");return i=!!i,this._Zip.file("book.opf",ejs.render(bookConfig,{i18n:this._I18n,uuid:this._Uuid,date:this._Date,title:this._Info.title,author:this._Info.author,publisher:this._Info.publisher,description:html2text(this._Info.description,!0),tags:this._Info.tags,cover:this._Cover,pages:this._Pages,notes:i,images:this._Images},{client:!0})),this._Zip.file("OEBPS/table-of-contents.html",ejs.render(tocInBook,{i18n:this._I18n,pages:this._Pages},{client:!0})),this._Zip.file("toc.ncx",ejs.render(toc,{i18n:this._I18n,uuid:this._Uuid,title:this._Info.title,author:this._Info.author,pages:this._Pages,notes:i},{client:!0})),this._Zip.generateAsync({type:e,mimeType:mime,compression:"DEFLATE",compressionOptions:{level:9}},t)}}return jEpub}));
//# sourceMappingURL=jepub.js.map
